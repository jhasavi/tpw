name: Cleanup staging verification

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0' # weekly check (UTC)

jobs:
  verify-and-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: |
          npm ci
      - name: Run verification migrations (non-destructive checks)
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
        run: |
          psql "$DATABASE_URL" -f migrations/005_cleanup_legacy_columns.sql
          psql "$DATABASE_URL" -f migrations/005_courses_cleanup.sql
          psql "$DATABASE_URL" -f migrations/005_lessons_cleanup.sql
      - name: Run smoke curl script
        env:
          API_BASE: ${{ secrets.STAGING_API_BASE }}
        run: |
          # run the existing smoke script against staging API
          bash scripts/run_smoke.sh $API_BASE
